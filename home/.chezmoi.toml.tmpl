{{/* Default static values */}}
{{ $gpgId := "061DF935B288405FF6B906169496153E284399EF" }}
{{ $sshId := "~/.ssh/cwel.pub" }}
{{- $email := "cwel@cwel.sh" -}}
{{ $themes := list
     "dark"
     "light"
}}

{{ $catppuccinFlavors := list
     "latte"
     "frappe"
     "macchiato"
     "mocha"
}}

{{ $catppuccinAccentColors := list
     "blue"
     "flamingo"
     "green"
     "lavender"
     "maroon"
     "mauve"
     "peach"
     "pink"
     "red"
     "rosewater"
     "sapphire"
     "sky"
     "teal"
     "yellow"
}}

{{/* Default dynamic values */}}

{{ $shell := "" }}
{{ $theme := "dark" }}
{{ $catppuccinLightFlavour := "latte" }}
{{ $catppuccinDarkFlavour := "mocha" }}
{{ $catppuccinAccentColor := "lavender" }}
{{- $isCloud := false -}}
{{- $isContainer := false -}}
{{- $isWSL := false -}}
{{- $isHeadless := false -}}
{{ $isLaptop := false }}


{{/* Check if its a linux box */}}
{{ $osId := .chezmoi.os }}
{{ if (and (eq .chezmoi.os "linux") (hasKey .chezmoi.osRelease "id")) }}
  {{ $osId = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id }}
{{ end }}

{{/* Check if running in WSL */}}
{{ if and (eq .chezmoi.os "linux") (or (stat "/proc/sys/fs/binfmt_misc/WSLInterop") (contains "microsoft" (output "uname" "-r" | lower))) }}
  {{ $isWSL = true }}
{{ end }}

{{/* Check if system is headless */}}
{{ if and (eq .chezmoi.os "linux") (not (or (env "DISPLAY") (env "WAYLAND_DISPLAY") (env "XDG_SESSION_TYPE"))) }}
  {{ $isHeadless = true }}
{{ end }}

{{/* Check if its a windows box */}}
{{ if eq $osId "windows" }}
  {{ $shell = "pwsh" }}
{{ else }}
  {{ $shell = "zsh" }}
{{ end }}

{{/* Check if running in a container */}}
{{ if eq .chezmoi.os "linux" }}
  {{ if or (stat "/.dockerenv") (contains "docker" (output "cat" "/proc/1/cgroup" | lower)) (contains "lxc" (output "cat" "/proc/1/cgroup" | lower)) }}
    {{ $isContainer = true }}
  {{ end }}
{{ end }}

{{/* Check if running in a cloud environment */}}
{{ if eq .chezmoi.os "linux" }}
  {{ if or (stat "/var/lib/cloud/instance") (stat "/var/lib/cloud/data") (stat "/proc/xen") (stat "/sys/hypervisor/uuid") }}
    {{ $isCloud = true }}
  {{ else if or (stat "/sys/class/dmi/id/product_uuid") (stat "/sys/class/dmi/id/product_name") }}
    {{ $dmiProduct := (output "cat" "/sys/class/dmi/id/product_name" | lower) }}
    {{ if or (contains "amazon" $dmiProduct) (contains "google" $dmiProduct) (contains "azure" $dmiProduct) (contains "digitalocean" $dmiProduct) }}
      {{ $isCloud = true }}
    {{ end }}
  {{ end }}
{{ end }}


{{/* Prompts */}}

{{ if stdinIsATTY }}
  {{/* $theme = promptChoice "Theme" $themes "dark" */}}
  {{/* $catppuccinLightFlavour = promptChoice "Catppuccin flavor for light mode" $catppuccinFlavors "latte" */}}
  {{/* $catppuccinDarkFlavour = promptChoice "Catppuccin flavor for dark mode" $catppuccinFlavors "mocha" */}}
  {{ $catppuccinAccentColor = promptChoice "Accent color" $catppuccinAccentColors "lavender" }}
{{ end }}

{{/* Semi prompts or auto */}}

{{ if lookPath "hostnamectl" }}
  {{ if eq (output "hostnamectl" "chassis") "laptop" }}
    {{ $isLaptop = true }}
  {{ end }}
{{ else if lookPath "wmic" }}
  {{ if eq (output "wmic" "computersystem" "get" "PCSystemType" "/VALUE" | trim) "PCSystemType=2" }}
    {{ $isLaptop = true }}
  {{ end }}
{{ else if stdinIsATTY }}
  {{ $isLaptop = promptBoolOnce . "isLaptop" "Is this a laptop" false }}
{{ end }}

{{/* Post auto */}}

{{ $catppuccinFlavor := "" }}
{{ if eq $theme "dark" }}
  {{ $catppuccinFlavor = $catppuccinDarkFlavour }}
{{ else }}
  {{ $catppuccinFlavor = $catppuccinLightFlavour }}
{{ end }}

{{/* Set editor tools based on environment */}}

{{ $editCommand := "code" }}
{{ $editArgs := list "--wait" }}
{{ $diffCommand := "code" }}
{{ $diffArgs := list "--wait" "--diff" }}
{{ $mergeCommand := "code" }}
{{ $mergeArgs := list "--wait" "--merge" "{{ .Destination }}" "{{ .Target }}" "{{ .Source }}" }}

{{ if $isHeadless }}
  {{ $editCommand = "nvim" }}
  {{ $editArgs = list }}
  {{ $diffCommand = "nvim" }}
  {{ $diffArgs = list "-d" }}
  {{ $mergeCommand = "nvim" }}
  {{ $mergeArgs = list "-d" "{{ .Destination }}" "{{ .Source }}" }}
{{ else if or $isContainer $isCloud }}
  {{ $editCommand = "vim" }}
  {{ $editArgs = list }}
  {{ $diffCommand = "vimdiff" }}
  {{ $diffArgs = list }}
  {{ $mergeCommand = "vim" }}
  {{ $mergeArgs = list "-d" "{{ .Destination }}" "{{ .Source }}" }}
{{ end }}

{{ if and $isWSL (not $isHeadless) (not $isContainer) (not $isCloud) }}
  {{ $editCommand = "code" }}
  {{ $editArgs = list "--wait" }}
  {{ $diffCommand = "code" }}
  {{ $diffArgs = list "--wait" "--diff" }}
  {{ $mergeCommand = "code" }}
  {{ $mergeArgs = list "--wait" "--merge" "{{ .Destination }}" "{{ .Target }}" "{{ .Source }}" }}
{{ end }}

encryption = "age"
mode = "file" # file or symlink
progress = true

[data]
theme = {{ $theme | quote }}
catppuccinLightFlavour = {{ $catppuccinLightFlavour | quote }}
catppuccinDarkFlavour = {{ $catppuccinDarkFlavour | quote }}
catppuccinFlavor = {{ $catppuccinFlavor | quote }}
catppuccinFlavorTitle = {{ $catppuccinFlavor | title | quote }}
catppuccinAccentColor = {{ $catppuccinAccentColor | quote }}
email = {{ $email | quote }}
gpgId = {{ $gpgId | quote }}
sshId = {{ $sshId | quote }}
osId = {{ $osId | quote }}
isLaptop = {{ $isLaptop }}
isWSL = {{ $isWSL }}
isHeadless = {{ $isHeadless }}
isCloud = {{ $isCloud }}
isContainer = {{ $isContainer }}

[data.catppuccin]
accentColors = [ {{ $catppuccinAccentColors | quoteList | join ", " }} ]
flavors = [ {{ $catppuccinFlavors | quoteList | join ", " }} ]

[age]
    identity = "~/.ssh/cwel"
    symmetric = true

[gpg]
recipient = {{ $gpgId | quote }}
args = ["--quiet"]

[git]
autoAdd = true
autoCommit = false
autoPush = false

[cd]
command = {{ $shell | quote }}

[edit]
command = {{ $editCommand | quote }}
args = [{{ range $editArgs }}{{ . | quote }}, {{ end }}]

[diff]
command = {{ $diffCommand | quote }}
args = [{{ range $diffArgs }}{{ . | quote }}, {{ end }}]

[merge]
command = {{ $mergeCommand | quote }}
args = [{{ range $mergeArgs }}{{ . | quote }}, {{ end }}]

[interpreters.ps1]
    command = "pwsh"
    args = ["-NoLogo"]

[onepassword]
    mode = "service"
