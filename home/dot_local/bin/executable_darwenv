#!/bin/bash
# darwinenv - Parse vars from file and set via launchctl

set -euo pipefail

ENV_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/environment.d"

for conf in "$ENV_DIR"/*.conf; do
    [[ -f "$conf" ]] || continue

    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

        if [[ "$line" =~ ^([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
            key="${BASH_REMATCH[1]}"
            value="${BASH_REMATCH[2]}"
            value=$(eval echo "$value")
            launchctl setenv "$key" "$value"
        fi
    done < "$conf"
done
