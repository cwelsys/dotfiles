#!/bin/bash

# Wrapper to run tte on some ascii

show_help() {
  cat <<EOF
Usage: screenie [FILE]

Arguments:
  FILE    Path to ascii file
EOF
}

if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
  show_help
  exit 0
fi

if [ $# -eq 0 ]; then
  config_default="$HOME/.config/screenie/default.txt"

  if [ -f "$config_default" ]; then
    file_path="$config_default"
  else

    os_name=$(uname -s | tr '[:upper:]' '[:lower:]')
    ascii_dir="$HOME/Pictures/ascii"
    os_file="$ascii_dir/$os_name.txt"

    if [ -f "$os_file" ]; then
      file_path="$os_file"
    else
      show_help
      exit 1
    fi
  fi
else

  ascii_dir="$HOME/Pictures/ascii"

  if [ -f "$1" ]; then
    file_path="$1"
  elif [ -f "$ascii_dir/$1.txt" ]; then
    file_path="$ascii_dir/$1.txt"
  elif [ -f "$ascii_dir/$1" ]; then
    file_path="$ascii_dir/$1"
  else
    show_help
    exit 1
  fi
fi

if ! command -v tte &>/dev/null; then
  echo "Error: tte command not found"
  exit 1
fi

exit_screenie() {
  pkill -x tte 2>/dev/null
  exit 0
}

trap exit_screenie SIGINT SIGTERM SIGHUP SIGQUIT

while true; do
  tte -i "$file_path" \
    --frame-rate 120 \
    --canvas-width 0 \
    --canvas-height 0 \
    --reuse-canvas \
    --anchor-canvas c \
    --anchor-text c \
    --random-effect \
    --exclude-effects matrix \
    --no-eol \
    --no-restore-cursor
done
