#!/bin/bash

screensaver_in_focus() {
  if [ -n "$NIRI_SOCKET" ]; then
    niri msg -j focused-window 2>/dev/null | jq -e '.app_id == "tte.screenie"' >/dev/null 2>&1
  elif [ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]; then
    hyprctl activewindow -j | jq -e '.class == "tte.screenie"' >/dev/null 2>&1
  fi
}

hide_cursor() {
  if [ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]; then
    hyprctl keyword cursor:invisible "$1" &>/dev/null
  fi
}

exit_screensaver() {
  hide_cursor false
  pkill -x tte 2>/dev/null
  pkill -f "tte.screenie" 2>/dev/null
  exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

printf '\033]11;rgb:00/00/00\007' # Set background color to black

hide_cursor true

# Cursor movement detection (Hyprland only)
if [ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]; then
  initial_cursorpos=$(hyprctl cursorpos 2>/dev/null || echo "0, 0")
fi

while true; do
  tte -i ~/.local/bin/screensaver.txt \
    --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c \
    --random-effect --exclude-effects matrix synthgrid sweep \
    --no-eol --no-restore-cursor &

  while pgrep -x tte >/dev/null; do
    if [ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]; then
      curr_cursorpos=$(hyprctl cursorpos 2>/dev/null || echo "0, 0")
      if [[ "$curr_cursorpos" != "$initial_cursorpos" ]]; then
        exit_screensaver
      fi
    fi

    if read -n 1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done
