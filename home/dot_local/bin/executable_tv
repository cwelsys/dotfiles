#!/usr/bin/env bash

set -euo pipefail

SPINNER_LIB="${HOME}/.local/share/spinners/spinner.sh"
[[ -f "$SPINNER_LIB" ]] && source "$SPINNER_LIB"

GAMING_HOST="main"
HA_URL="http://192.168.4.114:8123"
HA_TV_ENTITY="media_player.cwel_lgtv"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

log_info()    { echo -e "${CYAN}→${RESET} $1"; }
log_success() { echo -e "${GREEN}✓${RESET} $1"; }
log_error()   { echo -e "${RED}✗${RESET} $1" >&2; }
log_warn()    { echo -e "${YELLOW}!${RESET} $1"; }

check_token() {
    if [[ -z "${HA_TOKEN:-}" ]]; then
        log_error "HA_TOKEN not set"
        return 1
    fi
}

ha_call() {
    local endpoint="$1"
    local method="${2:-GET}"
    local data="${3:-}"

    check_token || return 1

    if [[ "$method" == "GET" ]]; then
        curl -sf -H "Authorization: Bearer $HA_TOKEN" "$HA_URL/api/$endpoint"
    else
        curl -sf -X POST -H "Authorization: Bearer $HA_TOKEN" \
            -H "Content-Type: application/json" \
            "$HA_URL/api/$endpoint" -d "$data"
    fi
}

tv_state() {
    local state
    state=$(ha_call "states/$HA_TV_ENTITY" | jq -r '.state' 2>/dev/null)
    echo "$state"
}

is_tv_on() {
    local state
    state=$(tv_state)
    [[ "$state" == "on" || "$state" == "playing" || "$state" == "paused" ]]
}

wait_for_tv() {
    for _ in {1..20}; do
        is_tv_on && return 0
        sleep 0.5
    done
    return 1
}

cmd_on() {
    if is_tv_on; then
        log_success "TV already on"
        return 0
    fi
    ha_call "services/media_player/turn_on" POST "{\"entity_id\":\"$HA_TV_ENTITY\"}" >/dev/null
    if type run_with_spinner &>/dev/null; then
        if run_with_spinner "dots" "Waiting for TV" "cyan" wait_for_tv; then
            printf "\r\033[K"
            log_success "TV is on"
        else
            printf "\r\033[K"
            log_error "TV failed to turn on"
            return 1
        fi
    else
        log_info "Turning TV on..."
        if wait_for_tv; then
            log_success "TV is on"
        else
            log_error "TV failed to turn on"
            return 1
        fi
    fi
}

cmd_off() {
    log_info "Turning TV off..."
    ha_call "services/media_player/turn_off" POST "{\"entity_id\":\"$HA_TV_ENTITY\"}" >/dev/null
    log_success "TV off"
}

cmd_input() {
    local source="${1:-}"
    if [[ -z "$source" ]]; then
        local sources
        sources=$(ha_call "states/$HA_TV_ENTITY" | jq -r '.attributes.source_list[]' 2>/dev/null)
        local current
        current=$(ha_call "states/$HA_TV_ENTITY" | jq -r '.attributes.source' 2>/dev/null)
        echo -e "${BOLD}Available inputs:${RESET}"
        while IFS= read -r s; do
            if [[ "$s" == "$current" ]]; then
                echo -e "  ${GREEN}● $s${RESET} (current)"
            else
                echo -e "  ${DIM}○ $s${RESET}"
            fi
        done <<< "$sources"
        return 0
    fi
    log_info "Switching to $source..."
    ha_call "services/media_player/select_source" POST "{\"entity_id\":\"$HA_TV_ENTITY\",\"source\":\"$source\"}" >/dev/null
    log_success "Switched to $source"
}

cmd_volume() {
    local level="${1:-}"
    if [[ -z "$level" ]]; then
        local vol
        vol=$(ha_call "states/$HA_TV_ENTITY" | jq -r '.attributes.volume_level // 0' 2>/dev/null)
        local pct
        pct=$(awk "BEGIN {printf \"%.0f\", $vol * 100}")
        echo "Volume: ${pct}%"
        return 0
    fi
    local vol_float
    vol_float=$(awk "BEGIN {printf \"%.2f\", $level / 100}")
    log_info "Setting volume to ${level}%..."
    ha_call "services/media_player/volume_set" POST "{\"entity_id\":\"$HA_TV_ENTITY\",\"volume_level\":$vol_float}" >/dev/null
    log_success "Volume set to ${level}%"
}

cmd_mute() {
    local muted
    muted=$(ha_call "states/$HA_TV_ENTITY" | jq -r '.attributes.is_volume_muted // false' 2>/dev/null)
    if [[ "$muted" == "true" ]]; then
        log_info "Unmuting..."
        ha_call "services/media_player/volume_mute" POST "{\"entity_id\":\"$HA_TV_ENTITY\",\"is_volume_muted\":false}" >/dev/null
        log_success "Unmuted"
    else
        log_info "Muting..."
        ha_call "services/media_player/volume_mute" POST "{\"entity_id\":\"$HA_TV_ENTITY\",\"is_volume_muted\":true}" >/dev/null
        log_success "Muted"
    fi
}

cmd_status() {
    check_token || return 1

    local data
    data=$(ha_call "states/$HA_TV_ENTITY") || { log_error "Failed to reach Home Assistant"; return 1; }

    local state source vol pct
    state=$(echo "$data" | jq -r '.state // "unknown"')
    source=$(echo "$data" | jq -r '.attributes.source // "unknown"')
    vol=$(echo "$data" | jq -r '.attributes.volume_level // 0')
    pct=$(awk "BEGIN {printf \"%.0f\", $vol * 100}")

    echo -e "${BOLD}TV Status${RESET}"
    if [[ "$state" == "on" || "$state" == "playing" || "$state" == "paused" ]]; then
        echo -e "  Power:  ${GREEN}ON${RESET}"
        echo -e "  Input:  $source"
        echo -e "  Volume: ${pct}%"
    else
        echo -e "  Power:  ${DIM}OFF${RESET}"
    fi
}

cmd_game() {
    local current_host
    current_host=$(hostname)

    if [[ "$current_host" == "$GAMING_HOST" ]]; then
        exec ~/.local/bin/gamer "$@"
    else
        exec ssh -t "$GAMING_HOST" "~/.local/bin/gamer $*"
    fi
}

show_help() {
    echo -e "${BOLD}tv${RESET} - TV and gaming session control"
    echo ""
    echo -e "${BOLD}TV Commands:${RESET}"
    echo -e "  ${CYAN}on${RESET}            Turn TV on"
    echo -e "  ${CYAN}off${RESET}           Turn TV off (standby)"
    echo -e "  ${CYAN}status${RESET}        Show TV status"
    echo -e "  ${CYAN}input${RESET} [NAME]  List inputs or switch to NAME"
    echo -e "  ${CYAN}volume${RESET} [0-100] Show or set volume"
    echo -e "  ${CYAN}mute${RESET}          Toggle mute"
    echo ""
    echo -e "${BOLD}Gaming Commands:${RESET}"
    echo -e "  ${CYAN}game${RESET} [CMD]    Control gaming session (runs on $GAMING_HOST)"
    echo -e "                 ${DIM}on, off, kill, switch, status${RESET}"
}

case "${1:-}" in
    on)      cmd_on ;;
    off)     cmd_off ;;
    input)   cmd_input "${2:-}" ;;
    volume)  cmd_volume "${2:-}" ;;
    mute)    cmd_mute ;;
    status)  cmd_status ;;
    game|g)  shift; cmd_game "$@" ;;
    help|-h|--help) show_help ;;
    "")      cmd_status ;;
    *)       log_error "Unknown command: $1"; show_help; exit 1 ;;
esac
