#!/bin/bash
# Sync available models from Ollama to opc config

CONFIG_FILE="${1:-$(chezmoi source-path)/dot_config/opencode/config.json}"
OLLAMA_BASE="https://slop.cwel.casa"

MODELS_JSON=$(curl -sL "$OLLAMA_BASE/v1/models" 2>/dev/null)

if echo "$MODELS_JSON" | jq -e '.data' >/dev/null 2>&1; then
    MODELS=$(echo "$MODELS_JSON" | jq -r '.data[].id')
elif MODELS_JSON=$(curl -sL "$OLLAMA_BASE/api/tags" 2>/dev/null) && echo "$MODELS_JSON" | jq -e '.models' >/dev/null 2>&1; then
    MODELS=$(echo "$MODELS_JSON" | jq -r '.models[].name')
else
    echo "Failed to fetch models from $OLLAMA_BASE"
    exit 1
fi

MODELS_OBJ=$(echo "$MODELS" | jq -Rn '
    [inputs | select(length > 0)] |
    map(. as $id | {
        ($id): {
            name: ($id | split("/") | last | split(":")[0] | gsub("-"; " "))
        }
    }) |
    add // {}
')

if [ -f "$CONFIG_FILE" ]; then
    jq --argjson models "$MODELS_OBJ" '.provider.ollama.models = $models' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    echo "Updated $(echo "$MODELS" | wc -l | tr -d ' ') models in $CONFIG_FILE"
else
    echo "Config file not found: $CONFIG_FILE"
    exit 1
fi
