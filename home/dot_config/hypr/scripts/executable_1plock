#!/bin/bash

# Prevent multiple instances
LOCKFILE="/tmp/1password-auto-unlock.lock"
if [ -f "$LOCKFILE" ]; then
  echo "Script already running, exiting"
  exit 0
fi
touch "$LOCKFILE"
trap "rm -f $LOCKFILE" EXIT

# Wait for 1Password to start in tray
sleep 4

# Get password from keyring
PASSWORD=$(secret-tool lookup application 1password username master)

if [ -z "$PASSWORD" ]; then
  echo "No password found in keyring"
  exit 1
fi

# Open 1Password app (this will show the unlock window if locked)
1password >/dev/null 2>&1 &

# Wait for the lock screen window to appear (max 5 seconds)
for i in {1..10}; do
  if hyprctl clients -j | jq -e '.[] | select(.title | contains("Lock Screen")) | select(.class == "1password")' >/dev/null 2>&1; then
    break
  fi
  sleep 0.5
done

# Get the window address
WINDOW_ADDR=$(hyprctl clients -j | jq -r '.[] | select(.title | contains("Lock Screen")) | select(.class == "1password") | .address' | head -1)

if [ -z "$WINDOW_ADDR" ]; then
  echo "ERROR: Could not find 1Password lock screen"
  exit 1
fi

# Get current workspace
CURRENT_WS=$(hyprctl activeworkspace -j | jq -r '.id')

# Move 1Password window to an empty workspace (workspace 99 - unlikely to be used)
hyprctl dispatch movetoworkspacesilent 99,"address:$WINDOW_ADDR" >/dev/null 2>&1
sleep 0.2

# Switch to that workspace
hyprctl dispatch workspace 99 >/dev/null 2>&1
sleep 0.3

# Focus the window
hyprctl dispatch focuswindow "address:$WINDOW_ADDR" >/dev/null 2>&1
sleep 0.3

# Type password (now isolated on empty workspace - no other windows to steal focus)
ydotool type "$PASSWORD"
sleep 0.2
ydotool key 28:1 28:0  # Enter

# Wait for unlock
sleep 1

# Close the window
hyprctl dispatch closewindow "address:$WINDOW_ADDR" >/dev/null 2>&1

# Return to original workspace
hyprctl dispatch workspace "$CURRENT_WS" >/dev/null 2>&1

echo "1Password unlocked"
