#!/bin/bash

LOCKFILE="/tmp/1password-auto-unlock.lock"
[ -f "$LOCKFILE" ] && exit 0
touch "$LOCKFILE"
trap "rm -f $LOCKFILE" EXIT

# Wait for 1Password
MAX_WAIT=30
WAITED=0
while ! pgrep -x "1password" >/dev/null 2>&1; do
  [ $WAITED -ge $MAX_WAIT ] && exit 1
  sleep 1
  WAITED=$((WAITED + 1))
done

# Get password from keyring
PASSWORD=$(secret-tool lookup application 1password username master)
[ -z "$PASSWORD" ] && exit 1

# Launch 1Password and wait for lock screen
1password >/dev/null 2>&1 &
for i in {1..20}; do
  WINDOW_ADDR=$(hyprctl clients -j | jq -r '.[] | select(.title | contains("Lock Screen")) | select(.class == "1password") | .address' | head -1)
  [ -n "$WINDOW_ADDR" ] && break
  sleep 0.5
done
[ -z "$WINDOW_ADDR" ] && exit 1

# Focus and type - no workspace switch
hyprctl dispatch focuswindow "address:$WINDOW_ADDR"
sleep 0.3
wtype -d 50 "$PASSWORD"
wtype -k Return

# Close window after unlock
sleep 1
hyprctl dispatch closewindow "address:$WINDOW_ADDR" 2>/dev/null

echo "1Password unlocked"
