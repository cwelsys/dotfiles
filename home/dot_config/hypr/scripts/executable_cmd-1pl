#!/bin/bash

LOCKFILE="/tmp/1password-auto-unlock.lock"
if [ -f "$LOCKFILE" ]; then
  echo "Script already running, exiting"
  exit 0
fi
touch "$LOCKFILE"
trap "rm -f $LOCKFILE" EXIT

MAX_WAIT=30
WAITED=0
while ! pgrep -x "1password" >/dev/null 2>&1; do
  if [ $WAITED -ge $MAX_WAIT ]; then
    echo "ERROR: 1Password not running after ${MAX_WAIT}s"
    exit 1
  fi
  sleep 1
  WAITED=$((WAITED + 1))
done
echo "1Password detected (waited ${WAITED}s)"

PASSWORD=$(secret-tool lookup application 1password username master)

if [ -z "$PASSWORD" ]; then
  echo "No password found in keyring"
  exit 1
fi

1password >/dev/null 2>&1 &

for i in {1..10}; do
  if hyprctl clients -j | jq -e '.[] | select(.title | contains("Lock Screen")) | select(.class == "1password")' >/dev/null 2>&1; then
    break
  fi
  sleep 0.5
done

WINDOW_ADDR=$(hyprctl clients -j | jq -r '.[] | select(.title | contains("Lock Screen")) | select(.class == "1password") | .address' | head -1)

if [ -z "$WINDOW_ADDR" ]; then
  echo "ERROR: Could not find 1Password lock screen"
  exit 1
fi

CURRENT_WS=$(hyprctl activeworkspace -j | jq -r '.id')

hyprctl dispatch movetoworkspacesilent 99,"address:$WINDOW_ADDR" >/dev/null 2>&1
sleep 0.2

hyprctl dispatch workspace 99 >/dev/null 2>&1
sleep 0.3

hyprctl dispatch focuswindow "address:$WINDOW_ADDR" >/dev/null 2>&1
sleep 0.3

ydotool type "$PASSWORD"
sleep 0.2
ydotool key 28:1 28:0 # Enter

sleep 1

hyprctl dispatch closewindow "address:$WINDOW_ADDR" >/dev/null 2>&1

hyprctl dispatch workspace "$CURRENT_WS" >/dev/null 2>&1

echo "1Password unlocked"
