#!/usr/bin/env bash

TV_MONITOR="HDMI-A-2"
TV_INPUT="HDMI 3"
STATE_FILE="/tmp/tv-gaming-steam-state"
HA_URL="http://192.168.4.114:8123"
HA_TOKEN_FILE="${HOME}/.config/hypr/scripts/.ha-token"
HA_TV_ENTITY="media_player.cwel_lgtv"

show_status() {
    if command -v hyprctl &>/dev/null; then
        local monitors_json=$(hyprctl monitors -j 2>/dev/null)
        local is_disabled=$(echo "$monitors_json" | jq -r ".[] | select(.name==\"$TV_MONITOR\") | .disabled" 2>/dev/null)
        if [[ "$is_disabled" == "false" ]]; then
            echo "Display: ✓"
        else
            echo "Display: ✘"
        fi
    fi

    if pgrep -f "gamescope.*steam" > /dev/null; then
        echo "Gamescope: ✓"
    else
        echo "Gamescope: ✘"
    fi

    echo ""
}

ACTION=""
if [ $# -eq 0 ]; then
    show_status
    echo "Usage: $0 {on|off|kill}"
    echo "  on     - Enable TV game mode"
    echo "  off    - Disable TV game mode"
    echo "  kill   - Kill gamescope and restore desktop Steam"
    exit 1
fi

case "${1}" in
    on)
        ACTION="on"
        ;;
    off)
        ACTION="off"
        ;;
    kill|--kill|-k)
        ACTION="kill"
        ;;
    *)
        echo "Usage: $0 {on|off|kill}"
        echo "  on     - Enable TV game mode"
        echo "  off    - Disable TV game mode"
        echo "  kill   - Kill gamescope and restore desktop Steam"
        exit 1
        ;;
esac

if command -v hyprctl &>/dev/null && [[ -z "$HYPRLAND_INSTANCE_SIGNATURE" ]]; then
    for pid in $(pgrep -P $(pgrep -u "$USER" Hyprland) 2>/dev/null); do
        [[ -f "/proc/$pid/environ" ]] || continue
        while IFS='=' read -r -d '' k v; do
            [[ "$k" =~ ^(HYPRLAND_INSTANCE_SIGNATURE|WAYLAND_DISPLAY|DISPLAY)$ ]] && export "$k=$v"
        done < "/proc/$pid/environ"
        [[ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]] && break
    done
fi

if [ -z "$XDG_RUNTIME_DIR" ]; then
    runtime_dir="/run/user/$(id -u)"
    if [ -d "$runtime_dir" ]; then
        export XDG_RUNTIME_DIR="$runtime_dir"
    fi
fi

if [ -f "$HA_TOKEN_FILE" ]; then
    HA_TOKEN=$(cat "$HA_TOKEN_FILE")
else
    echo "Warning: Home Assistant token file not found at $HA_TOKEN_FILE"
    HA_TOKEN=""
fi

is_tv_enabled() {
    local monitors_json=$(hyprctl monitors -j 2>/dev/null)
    if [ $? -ne 0 ] || [ -z "$monitors_json" ]; then
        echo "Error: Failed to get monitor information from hyprctl"
        return 1
    fi
    local is_disabled=$(echo "$monitors_json" | jq -r ".[] | select(.name==\"$TV_MONITOR\") | .disabled" 2>/dev/null)
    # If disabled is false or empty, the monitor is enabled
    [[ "$is_disabled" == "false" ]] || [[ -z "$is_disabled" ]]
}

is_tv_on() {
    if [ -z "$HA_TOKEN" ]; then
        echo "Warning: No Home Assistant token available"
        return 1
    fi

    local state=$(curl -s -H "Authorization: Bearer $HA_TOKEN" \
        "$HA_URL/api/states/$HA_TV_ENTITY" | jq -r '.state' 2>/dev/null)

    [[ "$state" == "on" || "$state" == "playing" || "$state" == "paused" ]]
}

wake_tv() {
    if [ -z "$HA_TOKEN" ]; then
        echo "Warning: No Home Assistant token, skipping TV wake"
        return 1
    fi

    if is_tv_on; then
        echo "TV is already on"
        return 0
    fi

    echo "Turning on TV..."
    curl -s -X POST -H "Authorization: Bearer $HA_TOKEN" \
        -H "Content-Type: application/json" \
        "$HA_URL/api/services/media_player/turn_on" \
        -d "{\"entity_id\":\"$HA_TV_ENTITY\"}" > /dev/null

    for i in {1..20}; do
        if is_tv_on; then
            echo "TV is on"
            return 0
        fi
        sleep 0.5
    done

    echo "Times up..."
    return 1
}

switch_tv_input() {
    if [ -z "$HA_TOKEN" ]; then
        echo "Warn: No HA token"
        echo "skipping input switch..."
        return 1
    fi

    echo "Switching TV to $TV_INPUT"
    curl -s -X POST -H "Authorization: Bearer $HA_TOKEN" \
        -H "Content-Type: application/json" \
        "$HA_URL/api/services/media_player/select_source" \
        -d "{\"entity_id\":\"$HA_TV_ENTITY\",\"source\":\"$TV_INPUT\"}" > /dev/null

    if [ $? -eq 0 ]; then
        echo "Switched to $TV_INPUT"
    else
        echo "Warn: Failed to switch input"
    fi
}

enable_display() {
    echo "Enabling TV display..."
    hyprctl keyword monitor "$TV_MONITOR,enable" > /dev/null
}

disable_display() {
    echo "Disabling TV display..."
    hyprctl keyword monitor "$TV_MONITOR,disable"
}

tv_standby() {
    if [ -z "$HA_TOKEN" ]; then
        echo "Warn: No HA token"
        echo "skipping TV standby..."
        return 1
    fi

    echo "Putting TV into standby..."
    curl -s -X POST -H "Authorization: Bearer $HA_TOKEN" \
        -H "Content-Type: application/json" \
        "$HA_URL/api/services/media_player/turn_off" \
        -d "{\"entity_id\":\"$HA_TV_ENTITY\"}" > /dev/null
}

is_desktop_steam_running() {
    pgrep -x "steam" > /dev/null && ! pgrep -f "gamescope.*steam" > /dev/null
}

is_gamescope_running() {
    pgrep -f "gamescope.*steam" > /dev/null
}

kill_desktop_steam() {
    if ! is_desktop_steam_running; then
        return 0
    fi

    echo "Killing Steam..."
    steam -shutdown &> /dev/null
    sleep 2

    if pgrep -x "steam" > /dev/null; then
        pkill -9 steam
    fi

    touch "$STATE_FILE"
    echo "Desktop Steam killed"
}

restart_desktop_steam() {
    if [ ! -f "$STATE_FILE" ]; then
        return 0
    fi

    echo "Restarting desktop Steam..."
    uwsm app -- steam -silent </dev/null &>/dev/null &
    sleep 2

    if pgrep -x "steam" > /dev/null; then
        echo "Desktop Steam restarted successfully"
    else
        echo "Warn: Desktop Steam may not have started"
    fi

    rm -f "$STATE_FILE"
}

launch_gamescope() {
    if is_gamescope_running; then
        echo "Gamescope is already running"
        return 0
    fi

    kill_desktop_steam

    echo "Launching Gamescope"

    local monitors_json=$(hyprctl monitors -j 2>/dev/null)
    local tv_width=$(echo "$monitors_json" | jq -r ".[] | select(.name==\"$TV_MONITOR\") | .width" 2>/dev/null)
    local tv_height=$(echo "$monitors_json" | jq -r ".[] | select(.name==\"$TV_MONITOR\") | .height" 2>/dev/null)
    local wrapper_script="/tmp/gamescope-launch-$$.sh"
    cat > "$wrapper_script" << EOF
#!/bin/bash
export WAYLAND_DISPLAY="$WAYLAND_DISPLAY"
export DISPLAY="$DISPLAY"
export XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR"
export HYPRLAND_INSTANCE_SIGNATURE="$HYPRLAND_INSTANCE_SIGNATURE"
export ENABLE_GAMESCOPE_WSI=1
exec gamescope -W $tv_width -H $tv_height -w $tv_width -h $tv_height --fullscreen --steam -- steam -gamepadui
EOF
    chmod +x "$wrapper_script"

    setsid -f bash "$wrapper_script" &>/dev/null &

    (sleep 10; rm -f "$wrapper_script") &>/dev/null &

    sleep 3

    if is_gamescope_running; then
        echo "Gamescope/Steam launched successfully"
    else
        echo "Warning: Gamescope/Steam may not have started properly"
        return 1
    fi
}

kill_gamescope() {
    if ! is_gamescope_running; then
        echo "Gamescope is not running"
        restart_desktop_steam
        return 0
    fi

    echo "Killing Gamescope..."
    pkill -f "gamescope.*steam"
    sleep 2
    if is_gamescope_running; then
        pkill -9 -f "gamescope.*steam"
    fi
    echo "Gamescope/Steam killed"
    restart_desktop_steam
}

case "$ACTION" in
    kill)
        kill_gamescope
        exit 0
        ;;

    off)
        echo "Turning TV gaming mode OFF..."
        disable_display
        # tv_standby
        ;;

    on)
        echo "Turning TV gaming mode ON..."

        if ! is_tv_on; then
            wake_tv
        else
            echo "TV is already on"
        fi

        switch_tv_input
        enable_display
        launch_gamescope
        ;;
esac
