#!/bin/bash
{{ if lookPath "brew" }}
{{- if hasKey .pkgs.hosts .hostname -}}
{{-   $hostPkgs := index .pkgs.hosts .hostname -}}

# Extract and add taps from formulae
{{-   $taps := list }}
{{-   if and (eq .chezmoi.os "darwin") (hasKey $hostPkgs "brews") }}
{{-     range $hostPkgs.brews }}
  {{-       if contains "/" . }}
    {{-       $parts := . | splitList "/" }}
    {{-       if eq (len $parts) 3 }}
      {{-       $tap := printf "%s/%s" (index $parts 0) (index $parts 1) }}
      {{-       $taps = append $taps $tap }}
    {{-       end }}
  {{-       end }}
{{-     end }}
{{-   end }}

brew bundle --file=/dev/stdin <<EOF
{{-   range ($taps | uniq) }}
tap {{ . | quote }}
{{-   end }}

{{-   if and (eq .chezmoi.os "darwin") (hasKey $hostPkgs "brews") }}
{{-     range $hostPkgs.brews }}
brew {{ . | quote }}
{{-     end }}
{{-   end }}
{{-   if and (eq .chezmoi.os "darwin") (hasKey $hostPkgs "casks") }}
{{-     range $hostPkgs.casks }}
cask {{ . | quote }}
{{-     end }}
{{-   end }}
EOF
{{- else }}
echo "⚠️  No package configuration found for hostname: {{ .hostname }}"
echo "💡 Run 'cmpack --clone <template-host>' to bootstrap this machine"
{{- end }}
{{- end }}
