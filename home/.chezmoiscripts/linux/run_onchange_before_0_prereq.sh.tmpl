#!/bin/bash

{{ if eq .chezmoi.os "linux" -}}
if getent group wheel >/dev/null; then
    sudo usermod -aG wheel "$USER"
elif getent group sudo >/dev/null; then
    sudo usermod -aG sudo "$USER"
fi

if sudo grep -Eq '^[# ]*%wheel ALL=\(ALL:ALL\) NOPASSWD: ALL' /etc/sudoers; then
    sudo sed -i 's/^#\?\(%wheel ALL=(ALL:ALL) NOPASSWD: ALL\)/\1/' /etc/sudoers
elif getent group wheel >/dev/null; then
    echo '%wheel ALL=(ALL:ALL) NOPASSWD: ALL' | sudo tee -a /etc/sudoers
fi

sudo tee /etc/sudoers.d/no-admin-flag > /dev/null <<'EOF'
# Disable creation of .sudo_as_admin_successful file
Defaults !admin_flag
EOF

{{- else if eq .chezmoi.osRelease.id "arch" }}
sudo sed -i 's/#Color/Color/' /etc/pacman.conf
sudo sed -i 's/#ParallelDownloads = 5/ParallelDownloads = 5/' /etc/pacman.conf

if ! grep -q "ILoveCandy" /etc/pacman.conf; then
    sudo sed -i '/^Color/a ILoveCandy' /etc/pacman.conf
fi

sudo pacman -Syu --noconfirm
if ! command -v yay &> /dev/null; then
sudo pacman -S --needed --noconfirm git base-devel && git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si && cd .. && rm -rf yay
fi
yay -Y --gendb
sudo pacman -S --needed --noconfirm procps-ng wget curl file git zsh age openssh

sudo sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
sudo locale-gen

{{ end }}

if ! command -v mise &> /dev/null; then
    echo "Installing mise..."
    curl https://mise.jdx.dev/install.sh | sh
    export PATH="$HOME/.local/bin:$PATH"
    echo "mise installed successfully"
else
    echo "mise already installed"
fi

FONT_DIR="$HOME/.local/share/fonts"
FONT_NAME="FantasqueSansM"
FONT_URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FantasqueSansMono.zip"

if [ ! -f "$FONT_DIR/FantasqueSansMNerdFont-Regular.ttf" ]; then
    echo "Installing FantasqueSansM Nerd Font..."
    mkdir -p "$FONT_DIR"
    cd /tmp
    curl -fLo "${FONT_NAME}.zip" "$FONT_URL"
    unzip -o "${FONT_NAME}.zip" -d "$FONT_DIR"
    rm -f "${FONT_NAME}.zip"
    fc-cache -fv
    echo "FantasqueSansM Nerd Font installed successfully"
else
    echo "FantasqueSansM Nerd Font already installed"
fi

{{   if or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu") }}
curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
  sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg && \
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
  sudo tee /etc/apt/sources.list.d/1password.list && \
  sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/ && \
  curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
  sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol && \
  sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22 && \
  curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
  sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg && \
  sudo apt update && sudo apt install 1password-cli -y
{{   else if eq .chezmoi.osRelease.id "fedora" }}
sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=\"https://downloads.1password.com/linux/keys/1password.asc\"" > /etc/yum.repos.d/1password.repo'
sudo dnf check-update -y 1password-cli && sudo dnf install 1password-cli -y
{{   else if eq .chezmoi.osRelease.id "arch" }}
yay -S 1password-cli --needed --noconfirm --mflags "--skippgpcheck"
{{   else if or (eq .chezmoi.osRelease.id "opensuse-leap") (eq .chezmoi.osRelease.id "opensuse-tumbleweed") }}
sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
sudo zypper addrepo https://downloads.1password.com/linux/rpm/stable/x86_64 1password
sudo zypper refresh 1password
sudo zypper install -y 1password-cli
{{   end }}
